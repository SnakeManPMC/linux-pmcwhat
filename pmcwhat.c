/*    pmcwhat for daydream (c) Snake Man, PMC 1999 - 2015. */#include <dd.h>#include <ddlib.h>#include <stdio.h>#include <stdlib.h>#include <string.h>#include "/upload1/code/include/pmc.h"const char version[] = "v0.2br4";/* 09-06-99 */struct dif *d;                 /* daydream shit? */struct DayDream_NodeInfo rock; /* nodeinfo?.data shit to 'rock' */struct userbase ddDude;        /* userbase shit */char node_data_name[40];       /* nodeinfo?.data filename */char buf[300];char Node[5];char Uname[25];char Action[25];char filename[13];char filesize[13];char Cpsrate[13];char templine[80];              /* line to store dsz data */char dsz_logpath[30];/* path + filename of dszlog */char clr_frame[80];char clr_header[80];char clr_footer[80];char clr_node[80];char clr_uname[80];char clr_fname[80];char clr_fsize[80];char clr_cps[80];char clr_action[80];char clr_ufiles[80];char clr_umegs[80];char clr_tfiles[80];char clr_tmegs[80];char clr_status[80];int done = 0, NodeNum, file_count, file_all_count, Idle = 0, FirstFile = 0;unsigned long total_user_megs = 0;unsigned long total_all_megs = 0;unsigned long tempmeg = 0;/* lets write the shit down */int WritePart(){	if (Idle == 0) /* if we are NOT idle */	{		sprintf(buf, "%s| %s%2s %s%-15s %s%-14s %s%10s %s%7s %s%21s %s|\n",		        clr_frame, clr_node, Node, clr_uname, Uname,		        clr_fname, filename, clr_fsize, filesize, clr_cps,		        Cpsrate, clr_action, Action, clr_frame);	}	else	{       /* if we are IDLE, then dont write filename/size/cps information */		sprintf(buf, "%s| %s%2s  %s%-12s %s%23s %s%23s %17s|\n|----------------------------------------------------------------------------|\n",		        clr_frame, clr_node, Node, clr_uname, Uname, clr_fname, ddDude.user_organization,		        clr_fsize, Action, clr_frame);	}	dd_sendstring(d, buf);	return 0;}/* user personal file/byte totals */int Total_User_Summary(){	sprintf(buf, "%s|    %sfiles: %s%3i  %sbytes: %s%10lu  %s(%s%4.0lu%smb)%40s|\n",	        clr_frame, clr_status, clr_tfiles, file_count, clr_status, clr_tmegs, total_user_megs,	        clr_status, clr_tmegs, total_user_megs / (1024 * 1024), clr_status, clr_frame);	dd_sendstring(d, buf);	dd_sendstring(d, "|----------------------------------------------------------------------------|\n");	total_user_megs = 0;	file_count = 0;	return 0;}/* all transfer totals - together :) */int Tot_Stat(){	sprintf(buf, "%s|      %stotal user files: %s%3i   %suser megs: %s%4lumb%36s|\n",	        clr_frame, clr_status, clr_tfiles, file_all_count, clr_status, clr_tmegs,	        total_all_megs / (1024 * 1024), clr_frame);	dd_sendstring(d, buf);	return 0;}/* what we see the first, the header */int Header(){	sprintf(buf, "%s                       pmcwhat %s (c) pmc 1996-2015\n"	        "%s.----------------------------------------------------------------------------.\n"	        "| %s#  username        filename & size            cps          ul / dl         %s|\n"	        "|----------------------------------------------------------------------------|\n", clr_header, version, clr_frame, clr_status, clr_frame);	dd_sendstring(d, buf);	return 0;}/* what we see the last, the footer */int Footer(){	sprintf(buf, "%s`-----------------------------------[ pmcwhat (c) snake man, pmc 1996-2015 ]-'\n"	        "%s exiting, no more transfers.\n"	        " [pmcwhat %s is very beta, report bugs to pmc]\n", clr_frame, clr_footer, version);	dd_sendstring(d, buf);	return 0;}/* reading colours from config file */int ConfigCFG(){	char temp1[80];	char temp2[80];	FILE *cfg_file;	sprintf(buf, "%s/pmc/pmcwhat.cfg", getenv("DAYDREAM"));	/* lets read the how_many_users_to_list_in_the_bulletin & colors */	cfg_file = fopen(buf, "rt");	if (!cfg_file)	{		dd_sendstring(d, buf);		exit(1);	}	fgets(temp1, 80, cfg_file); /*  1 frame color */	fgets(temp2, 80, cfg_file); /*  2 header color */	strncpy(clr_frame, temp1, strlen(temp1) - 1);	strncpy(clr_header, temp2, strlen(temp2) - 1);	fgets(temp1, 80, cfg_file); /*  3 footer color */	fgets(temp2, 80, cfg_file); /*  4 node color */	strncpy(clr_footer, temp1, strlen(temp1) - 1);	strncpy(clr_node, temp2, strlen(temp2) - 1);	fgets(temp1, 80, cfg_file); /*  5 uname color */	fgets(temp2, 80, cfg_file); /*  6 filename color */	strncpy(clr_uname, temp1, strlen(temp1) - 1);	strncpy(clr_fname, temp2, strlen(temp2) - 1);	fgets(temp1, 80, cfg_file); /*  7 filesize color */	fgets(temp2, 80, cfg_file); /*  8 cps color */	strncpy(clr_fsize, temp1, strlen(temp1) - 1);	strncpy(clr_cps, temp2, strlen(temp2) - 1);	fgets(temp1, 80, cfg_file); /*  9 action color */	fgets(temp2, 80, cfg_file); /* 10 ufiles color */	strncpy(clr_action, temp1, strlen(temp1) - 1);	strncpy(clr_ufiles, temp2, strlen(temp2) - 1);	fgets(temp1, 80, cfg_file); /* 11 user_megs color */	fgets(temp2, 80, cfg_file); /* 12 total files color */	strncpy(clr_umegs, temp1, strlen(temp1) - 1);	strncpy(clr_tfiles, temp2, strlen(temp2) - 1);	fgets(temp1, 80, cfg_file); /* 13 total_megs color */	fgets(temp2, 80, cfg_file); /* 14 status color */	strncpy(clr_tmegs, temp1, strlen(temp1) - 1);	strncpy(clr_status, temp2, strlen(temp1) - 1);	fclose(cfg_file);	return 0;}/* calculate the total megs transferred */int Megger(){	tempmeg = 0;	tempmeg = atol(filesize);	total_user_megs = (total_user_megs + tempmeg); /* add filesize to megs upped */	total_all_megs = (total_all_megs + tempmeg);   /* T0tAL megs increment */	file_count++;                                  /* increment one file to filecounter */	file_all_count++;                              /* increment all-files-upped         */	return 0;}/* routine to read dsz-log file */int DSZ_Read_Routine(){	int cx;	char *p;	if (done > 0)	{		strcpy(Node, "");		strcpy(Uname, "");	}/* if our user is looped once, remove name */	done++;	p = strtok(templine, " ");	if (strcmp(p, "S"))		strcpy(Action, "Downloading");	else		strcpy(Action, "Uploading");	p = strtok(NULL, " ");	strcpy(filesize, p);                  /* filesize from token */	for (cx = 1; cx < 4; cx++) p = strtok(NULL, " ");	/* do three times strtok */	strcpy(Cpsrate, p);	/* get cps rate */	for (cx = 1; cx < 7; cx++) p = strtok(NULL, " ");	/* six times here */	strcpy(filename, p);	/* get filename */	Megger();	strcpy(Cpsrate, f_format(Cpsrate));	strcpy(filesize, f_format(filesize));	return 0;}/* we have user online AND he is transferring stuff */void TransferLooper(){	int dszcnt = 0; /* first file indicator */	char *mystr;	FILE * DSZ_log_file;	done = 0; /* clear loop/username remove shit */	strcpy(Uname, ddDude.user_handle);	sprintf(dsz_logpath, "%sdszlog.%s", DDTMP, Node); /* take current nodes dszlog */	DSZ_log_file = fopen(dsz_logpath, "rt");	if (!DSZ_log_file)	{		dd_sendstring(d, "\nERROR at: dszlog file!");		Footer();		dd_close(d);		exit(1);	}	/* file after file we read dszlog */	while(!feof(DSZ_log_file))	{		dszcnt++;		fgets(templine, 80, DSZ_log_file);/* if we are end of DSZLOG and our counter is 1 *//* meaning: user uploading its first file of batch */		if ((feof(DSZ_log_file)) && (dszcnt == 1))		{			strcpy(Action, "first file");			strcpy(Cpsrate, "n/a");			strcpy(			        filename, "n/a");			strcpy(filesize, "n/a");			FirstFile = 1;			WritePart();		}		if (feof(DSZ_log_file))		{			fclose(DSZ_log_file);			break;		}		/* no more files left */		DSZ_Read_Routine();             /* um shitter :) */		WritePart();		/* write the file and rest */	}	mystr = strtok(rock.ddn_activity, " ");	/* take token */	mystr = strtok(NULL, " ");	/* and the one we want... */	strcpy(filename, mystr);                  /* here we go! */	sprintf(Cpsrate, "%d", rock.ddn_bpsrate); /* cps rate from cur file */	strcpy(Cpsrate, f_format(Cpsrate));       /* fix the cps rate */	strcpy(filesize, "0");                    /* replace filesize */	WritePart();}/* loop for nodes and check for users status */void Looper(){	FILE * datafile;	NodeNum = 0;/* read NODEINFO?.DATA file for userdatas */	while (NodeNum < 255)	{		NodeNum++;		sprintf(Node, "%i", NodeNum);		sprintf(node_data_name, "%snodeinfo%i.data", DDTMP, NodeNum);		datafile = fopen(node_data_name, "rb");		/* open nodeinfo?.data */		if (!datafile)		{       /* no user online! */			rock.ddn_userslot = -1;			printf("no user online!\n");		}		else		{       /* we have user online */			fread(&rock, sizeof(struct DayDream_NodeInfo), 1, datafile);			/* read the user stats */			fclose(datafile);		}/* if we have user online, open userbase to get Uname *//* then check if he is transferring */		if (rock.ddn_userslot != -1)		{			FILE * userf;			Idle = 0;			userf = fopen("/home/bbs/data/userbase.dat", "rb");			if (!userf)			{				dd_sendstring(d, "error at data/userbase.dat!\n");				Footer();				dd_close(d);				exit (1);			}			fseek(userf, rock.ddn_userslot * sizeof(struct userbase), SEEK_SET);			fread(&ddDude, sizeof(struct userbase), 1, userf);			/* user is doing?? */			fclose(userf);			/* if we have user uploading or downloading = TRANSFERRING */			if ((strstr(rock.ddn_activity, "UL:")) || (strstr(rock.ddn_activity, "DL:")) )			{				TransferLooper(); /*rock.ddn_activity */				if (FirstFile == 0)					Total_User_Summary();  /* write end the summary. */				else                           /* or write the end of line */					dd_sendstring(d, "|----------------------------------------------------------------------------|\n");			}			else			{				strcpy(Uname, ddDude.user_handle);				strcpy(filename, "none");				strcpy(filesize, "none");				strcpy(Cpsrate, "none");				strcpy(Action, rock.ddn_activity);				Idle = 1;				WritePart();			}		}	}}/* main biatch code starts here. whee we are so elite k0der! */int main(int argv, char *argc[]){	if (argv == 1)	{		printf("need to run from DayDream\n");		return 1;	}	d = dd_initdoor(argc[1]);	sprintf(buf, "using PMCWHAT %s", version);	dd_changestatus(d, buf);	dd_getstrval(d, buf, USER_HANDLE);	ConfigCFG();                    /* colors from pmcwhat.cfg file */	Header();	/* display header */	Looper();                       /* loop and loop and loop... */	if (total_all_megs > 0)		Tot_Stat();             /* display total trans stats */	Footer();	/* display footer */	dd_close(d);	return 0;}/* ===============================   format of dszlogfile of DayDream   1 = send / receive S/?   2 = filesize   3 = 0 (bps) ?   4 = bps ?   5 = cps   6 = cps (text)   7 = 0 (errors) ?   8 = errors   9 = 0   10 = 1024   11 = filename   12 = 0   ================================ */